@startuml Architecture Design
title Weather Station â€” High-level Architecture
skinparam componentStyle rectangle
left to right direction

package "Weather Station (Device)" as WS {
  component "Main" as Main
  component "Sensor Manager" as SensorManager
  component "ESP-NOW Manager" as EspNowManager
  component "Comm Manager" as CommManager
  component "Display Manager" as DisplayManager

  queue "espNowQueue" as Q_espNow
  queue "httpQueue" as Q_http
  queue "displayQueue" as Q_display

  node "Sensor Task" as SensorTask
  node "ESP-NOW Task" as EspNowTask
  node "Comm Task" as CommTask
  node "Display Task" as DisplayTask

  rectangle "Sensors & Peripherals" as Periph {
    [DHT22: Temp & Humidity] as DHT
    [BH1750: Light] as BH1750
    [Hall Anemometer: Pulse] as Anem
    [SSD1306 OLED Display] as SSD1306
  }

  artifact "Serial Console" as Serial
}

package "External Systems" {
  node "Actuator ESP32 (peer)" as ActuatorESP
  rectangle "MG90 Servo (MG90 9g)" as MG90
  cloud "HTTP Server / Cloud" as Server
}

' Startup and instantiation
Main --> SensorManager : instantiate & start
Main --> EspNowManager : instantiate & start
Main --> CommManager : instantiate & start
Main --> DisplayManager : instantiate & start

' Tasks creation
SensorManager --> SensorTask
EspNowManager --> EspNowTask
CommManager --> CommTask
DisplayManager --> DisplayTask

' Sensor data flow
DHT --> SensorTask : measurements
BH1750 --> SensorTask : measurements
Anem --> SensorTask : pulse counts
SensorTask --> Q_espNow : publish payload
SensorTask --> Q_http : publish payload
SensorTask --> Q_display : update display

' Consumers
Q_display --> DisplayTask : consume
DisplayTask --> SSD1306 : render
DisplayTask --> Serial : logs

Q_http --> CommTask : consume
CommTask --> Server : HTTP POST telemetry
CommTask --> Serial : logs

Q_espNow --> EspNowTask : consume
EspNowTask --> ActuatorESP : ESP-NOW message (peer/broadcast)
EspNowTask --> Serial : send status

' Actuator chain
ActuatorESP --> MG90 : PWM signal (servo control)

note right of SensorTask
sensor_payload: temp, humidity, lux, wind_kmh, seq
end note

note left of EspNowTask
Actuator communication modes:
- Broadcast if actuatorMac == FF:FF:...
- Peer delivery if actuatorMac configured
end note

@enduml